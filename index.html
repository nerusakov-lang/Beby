<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Карта Здоровья</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#FDFBF7">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Карта Здоровья">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23FDFBF7' width='192' height='192'/><g transform='translate(96, 96) scale(1)'><circle cx='0' cy='-10' r='20' fill='%23D4A574'/><ellipse cx='0' cy='10' rx='18' ry='22' fill='%23C8956D'/><circle cx='0' cy='0' r='12' fill='%23E8D5C4'/></g></svg>">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-primary: #FDFBF7;
    --bg-secondary: #F8F5F0;
    --bg-tertiary: #F2EFE9;
    --bg-card: #FFFFFF;
    --bg-input: #FAF8F5;
    
    --text-primary: #2D2A26;
    --text-secondary: #6B655D;
    --text-muted: #9C968E;
    
    --accent-primary: #D4A574;
    --accent-secondary: #C8956D;
    --accent-soft: #E8D5C4;
    
    --success: #7D9D7D;
    --danger: #C97C7D;
    
    --border: #E5E0D8;
    --border-light: #F0ECE6;
    
    --shadow-sm: 0 1px 3px rgba(45, 42, 38, 0.04);
    --shadow-md: 0 4px 12px rgba(45, 42, 38, 0.06);
    --shadow-lg: 0 8px 30px rgba(45, 42, 38, 0.08);
    
    --radius: 16px;
  }

  * {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    margin: 0; 
    padding: 0; 
    padding-bottom: 50px;
    min-height: 100vh;
    font-size: 16px;
    line-height: 1.6;
    font-weight: 400;
  }

  .header-section {
    padding: 20px 20px 30px;
    padding-top: max(20px, env(safe-area-inset-top));
    background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    border-bottom: 1px solid var(--border-light);
  }

  .header-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 24px;
    gap: 15px;
  }

  .progress-circle-container {
    flex-shrink: 0;
    position: relative;
    width: 70px;
    height: 70px;
  }

  .progress-circle {
    width: 70px;
    height: 70px;
    position: relative;
  }

  .progress-circle-bg {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--bg-card);
    border: 2px solid var(--border);
    box-shadow: var(--shadow-sm);
  }

  .progress-circle-fill {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(var(--accent-primary) var(--percentage), transparent 0%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-primary);
  }

  .progress-circle-inner {
    position: absolute;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: var(--bg-card);
    border: 2px solid var(--border);
    top: 9px;
    left: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-primary);
  }

  .settings-btn {
    background: var(--bg-card);
    width: 50px; 
    height: 50px; 
    border-radius: 14px;
    border: 1px solid var(--border); 
    display: flex; 
    align-items: center; 
    justify-content: center;
    color: var(--text-secondary); 
    cursor: pointer; 
    font-size: 20px;
    transition: all 0.3s ease;
    z-index: 5;
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
  }
  
  .settings-btn:active { 
    background: var(--bg-tertiary);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .title-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    font-weight: 600;
    margin: 0;
    line-height: 1.3;
    text-align: center;
    color: var(--text-primary);
    letter-spacing: -0.3px;
  }

  .child-subtitle {
    font-size: 14px;
    font-weight: 400;
    color: var(--text-muted);
    margin-top: 4px;
    text-align: center;
  }

  .date-capsule {
    position: relative;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: fit-content;
    margin: 0 auto 30px;
    transition: all 0.3s ease;
    overflow: hidden; 
    z-index: 1; 
    box-shadow: var(--shadow-sm);
  }
  
  .date-capsule:active { 
    background: var(--bg-tertiary);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .date-content-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px 24px;
    position: relative; 
    z-index: 0; 
  }

  .date-value { 
    font-size: 14px; 
    font-weight: 500; 
    color: var(--text-primary); 
  }

  .hidden-date-input {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0;
    z-index: 10;
    cursor: pointer;
    background: transparent;
    -webkit-appearance: none;
    border: none; 
    margin: 0; 
    padding: 0;
    color: transparent;
  }
  
  .hidden-date-input::-webkit-calendar-picker-indicator {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .container { 
    max-width: 600px; 
    margin: 0 auto; 
    padding: 0 20px; 
  }
  
  .grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 16px; 
    padding-bottom: 40px; 
  }

  .card {
    background: var(--bg-card);
    padding: 20px; 
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
    cursor: pointer; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex; 
    flex-direction: column; 
    justify-content: space-between;
    height: 130px;
    position: relative;
    box-shadow: var(--shadow-sm);
  }
  
  .card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .card:active { 
    background: var(--bg-tertiary);
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
  }

  .card-date-badge {
    background: var(--accent-soft);
    color: var(--accent-secondary);
    font-size: 10px; 
    font-weight: 600; 
    padding: 5px 10px; 
    border-radius: 6px;
    display: inline-block; 
    margin-bottom: 10px; 
    width: fit-content;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .card-title { 
    font-family: 'Playfair Display', serif;
    font-size: 17px; 
    font-weight: 500; 
    margin-bottom: auto; 
    line-height: 1.2;
    color: var(--text-primary);
  }
  
  .card-progress-wrapper {
    height: 4px;
    background: var(--border-light);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
  }
  
  .card-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    border-radius: 2px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .modal {
    display: none; 
    position: fixed; 
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg-primary); 
    z-index: 2000; 
    overflow-y: auto;
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .modal.open { display: block; }
  
  @keyframes slideUp { 
    from { transform: translateY(100%); } 
    to { transform: translateY(0); } 
  }

  .modal-header {
    background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    padding: 16px 20px;
    padding-top: max(16px, env(safe-area-inset-top));
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    position: sticky; 
    top: 0; 
    z-index: 50;
    border-bottom: 1px solid var(--border-light);
  }
  
  .modal-title { 
    font-family: 'Playfair Display', serif;
    font-weight: 600; 
    font-size: 20px;
    color: var(--text-primary);
  }

  .close-btn { 
    color: var(--text-secondary); 
    font-weight: 500; 
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 15px; 
    cursor: pointer; 
    padding: 0;
    min-width: 44px; 
    min-height: 44px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
  }
  
  .close-btn:active {
    background: var(--bg-tertiary);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .checklist-container, .settings-block { 
    background: var(--bg-card);
    margin: 20px;
    border-radius: 16px; 
    border: 1px solid var(--border-light);
    overflow: hidden;
    box-shadow: var(--shadow-md);
  }
  
  .checklist-container { 
    padding: 5px 0; 
    margin-bottom: 40px; 
  }

  .recommendations-container {
    background: var(--bg-card);
    margin: 20px;
    border-radius: 16px;
    border: 1px solid var(--border-light);
    padding: 20px;
    margin-bottom: 40px;
    box-shadow: var(--shadow-md);
  }

  .rec-item {
    padding: 12px 0;
    border-bottom: 1px solid var(--border-light);
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .rec-item:last-child {
    border-bottom: none;
  }

  .rec-bullet {
    color: var(--accent-primary);
    font-weight: 600;
    margin-right: 8px;
  }
  
  .check-item { 
    padding: 16px 20px; 
    border-bottom: 1px solid var(--border-light);
    display: flex; 
    align-items: center; 
    cursor: pointer; 
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    background: transparent;
  }
  
  .check-item:last-child { border: none; }
  
  .check-item:hover {
    background: var(--bg-secondary);
  }
  
  .check-item.checked { 
    opacity: 0.6;
  }
  
  .checkbox { 
    width: 24px; 
    height: 24px; 
    border-radius: 6px;
    background: var(--bg-input);
    border: 2px solid var(--border);
    margin-right: 14px; 
    flex-shrink: 0; 
    position: relative; 
    transition: all 0.25s ease; 
  }
  
  .check-item.checked .checkbox { 
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border-color: var(--accent-primary);
    box-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
  }
  
  .check-item.checked .checkbox::after { 
    content: '✓'; 
    position: absolute; 
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 14px;
  }
  
  .checkbox.bounce {
    animation: bounce 300ms ease;
  }
  
  @keyframes bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    75% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
  
  .item-content { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
  }
  
  .item-text { 
    font-weight: 400; 
    font-size: 15px; 
    line-height: 1.5;
    color: var(--text-primary);
    transition: color 0.2s; 
    letter-spacing: 0px;
  }
  
  .check-item.checked .item-text { 
    text-decoration: line-through; 
    color: var(--text-muted); 
  }

  .tabs { 
    display: flex; 
    background: var(--bg-secondary);
    padding: 4px; 
    border-radius: 12px; 
    margin: 20px;
    gap: 4px;
    overflow-x: auto;
    border: 1px solid var(--border-light);
  }
  
  .tab { 
    flex: 1;
    min-width: 80px;
    text-align: center; 
    padding: 12px; 
    font-size: 13px; 
    font-weight: 500; 
    border-radius: 8px; 
    cursor: pointer; 
    color: var(--text-muted);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    background: transparent;
    border: none;
    white-space: nowrap;
  }
  
  .tab.active { 
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: white;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
  }

  .setting-row { 
    padding: 16px 20px; 
    border-bottom: 1px solid var(--border-light);
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    color: var(--text-secondary);
  }
  
  .setting-row:last-child {
    border: none;
  }
  
  .setting-row input,
  .setting-row select {
    background: var(--bg-input);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    text-align: right; 
    font-size: 15px; 
    font-weight: 400; 
    color: var(--text-primary);
    width: auto;
    transition: all 0.3s ease;
  }

  .setting-row input:focus,
  .setting-row select:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 4px rgba(212, 165, 116, 0.12);
  }

  .btn-action { 
    display: block; 
    width: calc(100% - 40px); 
    margin: 12px 20px; 
    padding: 14px; 
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border-radius: 12px; 
    text-align: center; 
    color: white; 
    font-weight: 600; 
    border: none;
    cursor: pointer; 
    font-size: 15px; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
  }
  
  .btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(212, 165, 116, 0.4);
  }
  
  .btn-action:active { 
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
  }

  .badge { 
    font-size: 10px; 
    font-weight: 600; 
    text-transform: uppercase; 
    padding: 4px 8px; 
    border-radius: 4px; 
    margin-bottom: 8px; 
    display: inline-block;
    letter-spacing: 0.02em;
  }
  
  .badge.blue { 
    color: var(--accent-secondary);
    background: var(--accent-soft);
  }
  
  .badge.red { 
    color: var(--danger);
    background: #F5E8E8;
  }

  .badge.green {
    color: var(--success);
    background: #E8F0E8;
  }

  .delete-child-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid var(--danger);
    background: transparent;
    color: var(--danger);
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  
  .delete-child-btn:hover {
    background: var(--danger);
    color: white;
  }

  @media print {
    body { background: white; color: black; }
    .header-section, .modal-header, .tabs, .btn-action, .close-btn { display: none !important; }
    .modal { position: static; display: block; overflow: visible; }
    .checklist-container { border: 1px solid #ccc; margin: 0; }
    .check-item.checked { opacity: 1; }
    .print-header { display: block !important; border-bottom: 2px solid black; margin-bottom: 20px; }
  }
  
  .print-header { display: none; }
</style>
</head>
<body>

<div class="header-section">
  <div class="header-top">
    <div class="progress-circle-container">
      <div class="progress-circle">
        <div class="progress-circle-bg"></div>
        <div class="progress-circle-fill" id="main-progress-circle">
          <div class="progress-circle-inner" id="main-progress-percent">0%</div>
        </div>
      </div>
    </div>

    <div class="title-group">
      <h1>Карта здоровья</h1>
      <div class="child-subtitle" id="child-name-display">Малыш</div>
    </div>

    <button class="settings-btn" onclick="App.openSettings()">⚙</button>
  </div>

  <div class="date-capsule">
    <div class="date-content-wrapper">
       <span class="date-value" id="main-date-text">Выбрать дату</span>
    </div>
    <input type="date" id="main-date-input" class="hidden-date-input" onchange="App.updateMainDate(this.value)">
  </div>
</div>

<div class="container">
  <div class="grid" id="months-grid"></div>
</div>

<div id="settings-modal" class="modal">
  <div class="modal-header">
    <div class="modal-title">Настройки</div>
    <button class="close-btn" onclick="App.closeSettings()">Готово</button>
  </div>
  <div class="settings-block">
    <div class="setting-row">
      <span>Имя ребенка</span>
      <input type="text" id="setting-name" oninput="App.updateName(this.value)" placeholder="Малыш">
    </div>
    <div class="setting-row">
      <span>Выбрать профиль</span>
      <div style="display:flex;align-items:center;gap:10px">
        <select id="child-selector" onchange="App.switchChild(this.value)"></select>
        <button class="delete-child-btn" onclick="App.deleteChild()" title="Удалить профиль">✕</button>
      </div>
    </div>
  </div>
  <button class="btn-action" onclick="App.addNewChild()">+ Добавить ребенка</button>
  <button class="btn-action" onclick="App.exportPDF()">Сохранить PDF</button>
  <button class="btn-action" onclick="App.exportData()">Экспорт данных</button>
  <button class="btn-action" onclick="App.importData()">Импорт данных</button>
  <button class="btn-action" style="color:#d60011;" onclick="App.resetProgress()">Сбросить прогресс</button>
</div>

<div id="detail-view" class="modal">
  <div class="print-header">
    <h1 id="print-title">Отчет</h1>
    <p id="print-date"></p>
  </div>
  <div class="modal-header">
    <button class="close-btn" onclick="App.closeDetail()">Назад</button>
    <div class="modal-title" id="month-title-display">Месяц</div>
    <div style="width:44px"></div>
  </div>

  <button class="btn-action" onclick="App.addToCalendar()" style="margin-top:20px;">Добавить в календарь</button>

  <div class="tabs">
    <div class="tab active" onclick="App.setTab('dev')">Развитие</div>
    <div class="tab" onclick="App.setTab('med')">Врачи</div>
    <div class="tab" onclick="App.setTab('vac')">Вакцинация</div>
    <div class="tab" onclick="App.setTab('rec')">Рекомендации</div>
  </div>

  <div id="dev-container" class="checklist-container"></div>
  <div id="med-container" class="checklist-container" style="display:none;"></div>
  <div id="vac-container" class="checklist-container" style="display:none;"></div>
  <div id="rec-container" class="recommendations-container" style="display:none;"></div>
</div>

<script>
const App = (function() {
    
    const DB = [
      { id: 1, t: "1 Месяц", 
        dev: ["Прибавка веса 800-1200г", "Рост +3-4 см", "Держит голову 1-2 сек", "Поза эмбриона", "Фокус внимания 5-10 сек", "Рефлексы новорождённого"],
        med: ["Педиатр", "Невролог", "Хирург-ортопед", "Офтальмолог", "Детский стоматолог"],
        vac: ["БЦЖ (при выписке из роддома)", "Гепатит В (1-я)"],
        rec: ["Витамин D3: 1000 МЕ/сут с 4-й недели", "Сон на спине, жёсткий матрас, без подушек", "Выкладывание на живот: 2-3 мин 3-5 раз в день", "Купание ежедневно", "Прогулки на свежем воздухе"]
      },
      { id: 2, t: "2 Месяца", 
        dev: ["Социальная улыбка", "Комплекс оживления", "Держит голову 45°", "Следит за предметом", "Слуховое сосредоточение"],
        med: ["Педиатр"],
        vac: ["ОАК и ОАМ", "Пневмококк (1-я)", "Ротавирус (1-я)"],
        rec: ["Витамин D3: 1000 МЕ/сут", "Выкладывание на живот 10-15 мин", "Развитие зрения и слуха", "Формирование режима дня", "Гимнастика для младенцев"]
      },
      { id: 3, t: "3 Месяца", 
        dev: ["Переворот на бок", "Опора на предплечья", "Исчезает рефлекс Моро", "Смех вслух", "Гулит"],
        med: ["Педиатр", "Невролог"],
        vac: ["АКДС/Пентаксим (1-я)", "Полиомиелит (1-я)", "Гемофильная инфекция (1-я)", "Ротавирус (2-я)"],
        rec: ["Витамин D3", "Массаж", "Развитие тактильных ощущений", "Тренировка хватания", "Общение с ребёнком", "Профилактика плагиоцефалии"]
      },
      { id: 4, t: "4 Месяца", 
        dev: ["Переворот на живот", "Опора на прямые руки", "Захват ладонью", "Различает цвета", "Следит за движущимся предметом"],
        med: ["Педиатр"],
        vac: ["Пневмококк (2-я)"],
        rec: ["Безопасность: не оставлять на возвышенности", "Игра в ку-ку", "Игрушки-прорезыватели", "Менять положение игрушек", "Развитие координации"]
      },
      { id: 5, t: "5 Месяцев", 
        dev: ["Переворот на спину", "Поза самолётика", "Лепет (ба-ба, ма-ма)", "Различает свой/чужой", "Ноги в рот"],
        med: ["Педиатр"],
        vac: ["АКДС/Пентаксим (2-я)", "Полиомиелит (2-я)", "Ротавирус (3-я)"],
        rec: ["Безопасность: не оставлять одного", "Подготовка к прикорму", "Стимуляция ползания", "Развитие речи", "Игры: ладушки, сорока-ворона", "Прорезывание зубов"]
      },
      { id: 6, t: "6 Месяцев", 
        dev: ["Сидит с опорой", "Ползает по-пластунски", "Начинает прикорм", "Щипковый захват", "Ищет упавший предмет"],
        med: ["Педиатр", "Невролог", "Хирург-ортопед"],
        vac: ["АКДС/Пентаксим (3-я)", "Полиомиелит (3-я)", "Гепатит В (3-я)"],
        rec: ["Безопасность: розетки, ящики, углы", "Полосы препятствий для ползания", "Прорезыватели для зубов", "Развитие самостоятельности", "Первый прикорм: овощи"]
      }
    ];

    let children = [];
    let curId = '';
    let curMonth = 1;
    let curTab = 'dev';

    const getKid = () => children.find(k => k.id === curId);
    
    const save = () => {
        try {
            localStorage.setItem('kids_v3', JSON.stringify(children)); 
            localStorage.setItem('curId_v3', curId);
        } catch (e) { console.error(e); }
    };

    const load = () => {
        try {
            const stored = localStorage.getItem('kids_v3');
            children = stored ? JSON.parse(stored) : [];
            if (!children.length) children = [{id: 'k1', name: 'Малыш', dob: ''}];
            curId = localStorage.getItem('curId_v3') || children[0].id;
            if (!getKid()) curId = children[0].id;
        } catch (e) {
            children = [{id: 'k1', name: 'Малыш', dob: ''}];
            curId = 'k1';
        }
    };

    const getTodayStr = () => new Date().toISOString().split('T')[0];
    const isValidDate = (d) => d instanceof Date && !isNaN(d);

    const init = () => {
        load();
        document.getElementById('main-date-input').max = getTodayStr();
        updateUI();
        renderGrid();
        updateMainProgress();
        registerServiceWorker();
    };

    const registerServiceWorker = () => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('✅ Service Worker'))
                .catch(err => console.log('SW error:', err));
        }
    };

    const updateMainProgress = () => {
        let totalItems = 0, completedItems = 0;
        
        DB.forEach(m => {
            ['dev', 'med', 'vac'].forEach(type => {
                if (m[type]) {
                    m[type].forEach((_, i) => {
                        totalItems++;
                        if(localStorage.getItem(`${curId}_m${m.id}_${type}_${i}`) === '1') {
                            completedItems++;
                        }
                    });
                }
            });
        });

        const percentage = totalItems ? Math.round((completedItems / totalItems) * 100) : 0;
        document.getElementById('main-progress-percent').innerText = percentage + '%';
        document.getElementById('main-progress-circle').style.setProperty('--percentage', (percentage * 3.6) + 'deg');
    };

    const updateUI = () => {
        const kid = getKid();
        if (!kid) return;

        document.getElementById('child-name-display').innerText = kid.name;
        document.getElementById('setting-name').value = kid.name;

        const dateInput = document.getElementById('main-date-input');
        const dateText = document.getElementById('main-date-text');
        
        dateInput.value = kid.dob || '';
        
        if (kid.dob) {
            const d = new Date(kid.dob);
            if (isValidDate(d)) {
                dateText.innerText = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
                dateText.style.color = '#555';
            } else {
                dateText.innerText = "Ошибка даты";
            }
        } else {
            dateText.innerText = "Выбрать дату";
            dateText.style.color = '#999';
        }

        const sel = document.getElementById('child-selector');
        sel.innerHTML = '';
        children.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.text = c.name;
            opt.selected = c.id === curId;
            sel.appendChild(opt);
        });
    };

    const renderGrid = () => {
        const grid = document.getElementById('months-grid');
        grid.innerHTML = '';
        
        const kid = getKid();
        let dobObj = null;
        if (kid.dob) {
            dobObj = new Date(kid.dob);
            if (!isValidDate(dobObj)) dobObj = null;
        }

        DB.forEach(m => {
            let dateStr = '-- . --';
            if (dobObj) {
                try {
                    const visitDate = new Date(dobObj);
                    visitDate.setMonth(visitDate.getMonth() + m.id);
                    if (isValidDate(visitDate)) {
                        dateStr = visitDate.toLocaleDateString('ru-RU', { day:'numeric', month:'short' });
                    }
                } catch(e) {}
            }

            let total=0, done=0;
            ['dev','med','vac'].forEach(type => {
                if (m[type]) {
                    m[type].forEach((_, i) => {
                        total++;
                        if(localStorage.getItem(`${curId}_m${m.id}_${type}_${i}`) === '1') done++;
                    });
                }
            });
            const pct = total ? Math.round((done/total)*100) : 0;

            grid.innerHTML += `
              <div class="card" onclick="App.openDetail(${m.id})">
                <span class="card-date-badge">${dateStr}</span>
                <div class="card-title">${m.t}</div>
                <div class="card-progress-wrapper">
                  <div class="card-progress-bar" style="width:${pct}%"></div>
                </div>
              </div>
            `;
        });
    };

    const updateMainDate = (val) => {
        if (!val) return;
        if (new Date(val) > new Date()) {
            alert("Дата не может быть в будущем!");
            updateUI();
            return;
        }
        const kid = getKid();
        kid.dob = val;
        save();
        updateUI();
        renderGrid();
    };

    const updateName = (val) => {
        getKid().name = val;
        save();
        document.getElementById('child-name-display').innerText = val;
    };

    const addNewChild = () => {
        const n = prompt("Имя ребенка:");
        if (n) {
            const nid = 'k' + Date.now();
            children.push({id: nid, name: n, dob: ''});
            switchChild(nid);
            closeSettings();
        }
    };

    const switchChild = (id) => {
        curId = id;
        save();
        init();
    };

    const deleteChild = () => {
        if (children.length <= 1) {
            alert("Нельзя удалить единственный профиль");
            return;
        }
        const kid = getKid();
        if (!confirm(`Удалить профиль "${kid.name}" и все данные?`)) return;
        
        Object.keys(localStorage).forEach(k => {
            if (k.startsWith(curId + '_')) localStorage.removeItem(k);
        });
        
        children = children.filter(c => c.id !== curId);
        curId = children[0].id;
        save();
        init();
    };

    const resetProgress = () => {
        if (confirm("Сбросить все галочки?")) {
            Object.keys(localStorage).forEach(k => {
                if (k.startsWith(curId + '_m')) localStorage.removeItem(k);
            });
            closeSettings();
            init();
        }
    };

    const openDetail = (mid) => {
        curMonth = mid;
        const mData = DB.find(x => x.id === mid);
        document.getElementById('month-title-display').innerText = mData.t;
        
        const k = getKid();
        let printDateStr = 'Дата не выбрана';
        if (k.dob) {
            const d = new Date(k.dob);
            if (isValidDate(d)) {
                d.setMonth(d.getMonth() + mid);
                printDateStr = d.toLocaleDateString();
            }
        }
        document.getElementById('print-title').innerText = `${mData.t} — ${k.name}`;
        document.getElementById('print-date').innerText = `Плановая дата: ${printDateStr}`;
        document.getElementById('detail-view').classList.add('open');
        setTab('dev');
    };

    const closeDetail = () => {
        document.getElementById('detail-view').classList.remove('open');
        renderGrid();
        updateMainProgress();
    };

    const setTab = (name) => {
        curTab = name;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab').forEach((t, i) => {
            if ((name === 'dev' && i === 0) || (name === 'med' && i === 1) || (name === 'vac' && i === 2) || (name === 'rec' && i === 3)) {
                t.classList.add('active');
            }
        });

        document.getElementById('dev-container').style.display = (name === 'dev') ? 'block' : 'none';
        document.getElementById('med-container').style.display = (name === 'med') ? 'block' : 'none';
        document.getElementById('vac-container').style.display = (name === 'vac') ? 'block' : 'none';
        document.getElementById('rec-container').style.display = (name === 'rec') ? 'block' : 'none';

        if (name === 'dev' || name === 'med' || name === 'vac') {
            renderList();
        } else if (name === 'rec') {
            renderRecommendations();
        }
    };

    const renderList = () => {
        const list = curTab === 'dev' ? document.getElementById('dev-container') : curTab === 'med' ? document.getElementById('med-container') : document.getElementById('vac-container');
        list.innerHTML = '';
        const mData = DB.find(x => x.id === curMonth);
        
        mData[curTab].forEach((txt, idx) => {
            const key = `${curId}_m${curMonth}_${curTab}_${idx}`;
            const isChecked = localStorage.getItem(key) === '1';
            const badgeType = curTab === 'med' ? 'red' : curTab === 'vac' ? 'green' : 'blue';
            const badgeTxt = curTab === 'med' ? 'Врачи' : curTab === 'vac' ? 'Вакцинация' : 'Развитие';

            list.innerHTML += `
              <div class="check-item ${isChecked?'checked':''}" onclick="App.toggleCheck('${key}', this)">
                <div class="checkbox"></div>
                <div class="item-content">
                  <span class="badge ${badgeType}">${badgeTxt}</span>
                  <div class="item-text">${txt}</div>
                </div>
              </div>
            `;
        });
    };

    const renderRecommendations = () => {
        const list = document.getElementById('rec-container');
        list.innerHTML = '';
        const mData = DB.find(x => x.id === curMonth);
        
        mData.rec.forEach((txt) => {
            list.innerHTML += `
              <div class="rec-item">
                <span class="rec-bullet">•</span>${txt}
              </div>
            `;
        });
    };

    const toggleCheck = (key, el) => {
        el.classList.toggle('checked');
        const isChecked = el.classList.contains('checked');
        localStorage.setItem(key, isChecked ? '1' : '0');
        
        const checkbox = el.querySelector('.checkbox');
        if (isChecked && checkbox) {
            checkbox.classList.add('bounce');
            setTimeout(() => checkbox.classList.remove('bounce'), 300);
        }
        
        if (navigator.vibrate) navigator.vibrate(5);
        updateMainProgress();
    };

    const exportPDF = () => {
        const printWindow = window.open('', '_blank');
        if (!printWindow) { alert('Разрешите всплывающие окна для печати'); return; }
        
        let html = `
        <!DOCTYPE html>
        <html lang="ru">
        <head>
            <meta charset="UTF-8">
            <title>Карта здоровья - ${getKid()?.name || 'Ребенок'}</title>
            <style>
                body { font-family: 'Inter', sans-serif; padding: 20px; color: #2D2A26; }
                h1 { font-family: 'Playfair Display', serif; text-align: center; color: #2D2A26; }
                h2 { font-family: 'Playfair Display', serif; color: #2D2A26; border-bottom: 2px solid #D4A574; padding-bottom: 8px; margin-top: 30px; }
                .child-name { text-align: center; color: #6B655D; margin-bottom: 30px; }
                .month-section { margin-bottom: 30px; page-break-inside: avoid; }
                .checklist { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                .check-item { padding: 8px 12px; background: #F8F5F0; border-radius: 8px; }
                .check-item.checked { background: #E8F0E8; text-decoration: line-through; color: #6B655D; }
                .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 8px; }
                .badge.dev { background: #E8D5C4; color: #C8956D; }
                .badge.med { background: #F5E8E8; color: #C97C7D; }
                .badge.vac { background: #E8F0E8; color: #7D9D7D; }
                @media print { body { padding: 0; } }
            </style>
        </head>
        <body>
            <h1>Карта здоровья</h1>
            <p class="child-name">${getKid()?.name || 'Ребенок'}</p>
        `;
        
        DB.forEach(m => {
            html += `<div class="month-section"><h2>${m.t}</h2><div class="checklist">`;
            
            ['dev', 'med', 'vac'].forEach(type => {
                if (!m[type]) return;
                const badgeClass = type === 'dev' ? 'dev' : type === 'med' ? 'med' : 'vac';
                const badgeLabel = type === 'dev' ? 'Развитие' : type === 'med' ? 'Врачи' : 'Вакцинация';
                m[type].forEach((txt, idx) => {
                    const key = `${curId}_m${m.id}_${type}_${idx}`;
                    const isChecked = localStorage.getItem(key) === '1';
                    html += `<div class="check-item ${isChecked ? 'checked' : ''}"><span class="badge ${badgeClass}">${badgeLabel}</span>${txt}</div>`;
                });
            });
            
            html += `</div></div>`;
        });
        
        html += `</body></html>`;
        
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); };
    };

    const exportData = () => {
        const data = {
            children: children,
            curId: curId,
            progress: {}
        };
        Object.keys(localStorage).forEach(k => {
            if (k.endsWith('_v3') || k.startsWith('kids_') || k.startsWith('curId_') || k.includes('_m')) {
                data.progress[k] = localStorage.getItem(k);
            }
        });
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `health-card-backup-${getTodayStr()}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };

    const importData = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.children && data.progress) {
                        children = data.children;
                        curId = data.curId || children[0].id;
                        Object.entries(data.progress).forEach(([k, v]) => {
                            localStorage.setItem(k, v);
                        });
                        save();
                        init();
                        alert('Данные восстановлены!');
                    } else {
                        alert('Неверный формат файла');
                    }
                } catch(err) {
                    alert('Ошибка чтения файла');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    };

    const addToCalendar = () => {
        const k = getKid();
        if (!k.dob) { alert("Укажите дату рождения!"); return; }
        const m = DB.find(x => x.id === curMonth);
        const d = new Date(k.dob);
        d.setMonth(d.getMonth() + m.id);
        const dt = d.toISOString().replace(/-|:|\.\d+/g, "").substring(0,8);
        const txt = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART;VALUE=DATE:${dt}\nSUMMARY:${k.name}: ${m.t}\nDESCRIPTION:Чек-ап здоровья.\nEND:VEVENT\nEND:VCALENDAR`;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type:'text/calendar'}));
        a.download = `checkup_${m.id}.ics`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };

    const openSettings = () => { 
        document.getElementById('settings-modal').classList.add('open');
        updateUI(); 
    };
    
    const closeSettings = () => { 
        document.getElementById('settings-modal').classList.remove('open'); 
    };

    return {
        init, openSettings, closeSettings, openDetail, closeDetail,
        updateMainDate, updateName, switchChild, addNewChild, deleteChild, resetProgress,
        exportPDF, exportData, importData, addToCalendar, setTab, toggleCheck
    };
})();

window.onload = App.init;
</script>
</body>
</html>
